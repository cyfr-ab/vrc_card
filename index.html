<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VRChat 自己紹介カードメーカー</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Orbitron:wght@600&family=Cinzel:wght@600&family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>VRChat 自己紹介カードメーカー</h1>
      <p class="subtitle">縦長 3:4 カード。背景透かしなどでアレンジできます。</p>
    </header>

    <main class="main">
      <section class="editor">
        <h2>入力フォーム</h2>
        <form id="cardForm" class="form">
          <div class="form-group">
            <label for="avatarInput">アバター画像</label>
            <div class="avatar-input-wrap">
              <input type="file" id="avatarInput" accept="image/*" class="avatar-input">
              <span class="avatar-hint">PNG / JPG（画像で保存する場合はアップロード推奨）</span>
            </div>
          </div>
          <div class="form-group">
            <label for="watermarkInput">背景用画像（透かし）</label>
            <div class="avatar-input-wrap">
              <input type="file" id="watermarkInput" accept="image/*" class="avatar-input">
              <div class="watermark-opacity-wrap">
                <label for="watermarkOpacity">透過度 <span id="watermarkOpacityValue">30</span>%</label>
                <input type="range" id="watermarkOpacity" min="5" max="80" value="30" class="opacity-range">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="vrName">VRChat名 <span class="required">*</span></label>
            <input type="text" id="vrName" placeholder="あなたのユーザー名" required>
          </div>
          <div class="form-group">
            <label for="pronouns">代名詞 (Pronouns)</label>
            <input type="text" id="pronouns" placeholder="例: he/him, she/her, they/them">
          </div>
          <div class="form-group">
            <label>ステータス（話し方・コミュニケーション）</label>
            <p class="tag-hint">該当するものを選んでください（複数可）</p>
            <div class="status-tags" id="statusTagList" role="group" aria-label="ステータスタグ">
              <label class="tag-choice"><input type="checkbox" name="status" value="無言勢"> 無言勢</label>
              <label class="tag-choice"><input type="checkbox" name="status" value="たまに喋る"> たまに喋る</label>
              <label class="tag-choice"><input type="checkbox" name="status" value="普通に喋る"> 普通に喋る</label>
              <label class="tag-choice"><input type="checkbox" name="status" value="ガチ勢"> ガチ勢</label>
              <label class="tag-choice"><input type="checkbox" name="status" value="テキスト多め"> テキスト多め</label>
              <label class="tag-choice"><input type="checkbox" name="status" value="ボイス多め"> ボイス多め</label>
            </div>
          </div>
          <div class="form-group">
            <label for="oneLiner">一言・自己紹介</label>
            <textarea id="oneLiner" rows="2" placeholder="簡単な自己紹介や挨拶"></textarea>
          </div>
          <div class="form-group">
            <label for="activeTime">活動時間帯</label>
            <input type="text" id="activeTime" placeholder="例: 夜21時〜、土日メイン">
          </div>
          <div class="form-group">
            <label for="favorite">好きなワールド・アバター</label>
            <textarea id="favorite" rows="2" placeholder="好きなワールドやアバターのジャンル"></textarea>
          </div>
          <div class="form-group">
            <label for="friendRequest">フレンド申請</label>
            <input type="text" id="friendRequest" placeholder="例: 一言いただければOK、気軽にどうぞ">
          </div>
          <div class="form-group">
            <label for="hobby">趣味・興味</label>
            <input type="text" id="hobby" placeholder="例: 音楽、ゲーム、アバター制作">
          </div>
          <div class="form-row theme-row">
            <label>カードのテーマ</label>
            <div class="theme-buttons">
              <button type="button" class="theme-btn active" data-theme="modern">ライト</button>
              <button type="button" class="theme-btn" data-theme="industrial">ダーク</button>
              <button type="button" class="theme-btn" data-theme="fantasy">エレガント</button>
              <button type="button" class="theme-btn" data-theme="kawaii">ふわふわ</button>
              <button type="button" class="theme-btn" data-theme="chocolate">チョコレート</button>
            </div>
          </div>
        </form>
      </section>

      <section class="preview-section">
        <h2>プレビュー（3:4 縦長）</h2>
        <div class="preview-wrap">
          <div id="cardPreview" class="card modern deco-none">
            <div class="card-watermark" id="cardWatermark"></div>
            <div class="card-inner">
              <div class="card-avatar">
                <img id="avatarPreview" class="avatar-img" style="display:none;">
                <div id="avatarPlaceholder" class="avatar-placeholder">画像を選択</div>
              </div>
              <div class="card-content">
                <div class="card-header">
                  <span class="card-badge">VRChat</span>
                  <h3 id="previewName" class="card-name">VRChat名</h3>
                  <p id="previewPronouns" class="card-pronouns"></p>
                </div>
                <div class="card-body">
                  <div id="previewOneLiner" class="card-line item"></div>
                  <div id="previewActiveTime" class="card-line item"></div>
                  <div id="previewFavorite" class="card-line item"></div>
                  <div id="previewFriendRequest" class="card-line item"></div>
                  <div id="previewHobby" class="card-line item"></div>
                </div>
              </div>
              <div class="card-status">
                <span class="card-status-label">ステータス</span>
                <div id="statusTagsPreview" class="status-tags-preview"></div>
              </div>
            </div>
            <div class="card-decoration"></div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>VRChat 自己紹介カードメーカー — Twitter・オフ会用</p>
    </footer>
  </div>

<script>
  /* ===============================
   VRChat 自己紹介カードメーカー
   inline版：プレビュー同期 + 透かし + テーマ +（あれば）縁装飾 + スクショ用ポップアップ
   =============================== */
(() => {
  const $ = (id) => document.getElementById(id);

  // ---- DOM ----
  const fields = {
    vrName: $('vrName'),
    pronouns: $('pronouns'),
    oneLiner: $('oneLiner'),
    activeTime: $('activeTime'),
    favorite: $('favorite'),
    friendRequest: $('friendRequest'),
    hobby: $('hobby'),
  };

  const preview = {
    name: $('previewName'),
    pronouns: $('previewPronouns'),
    oneLiner: $('previewOneLiner'),
    activeTime: $('previewActiveTime'),
    favorite: $('previewFavorite'),
    friendRequest: $('previewFriendRequest'),
    hobby: $('previewHobby'),
  };

  const avatarInput = $('avatarInput');
  const avatarPreview = $('avatarPreview');
  const avatarPlaceholder = $('avatarPlaceholder');

  const watermarkInput = $('watermarkInput');
  const watermarkOpacity = $('watermarkOpacity');
  const watermarkOpacityValue = $('watermarkOpacityValue');
  const cardWatermark = $('cardWatermark');

  const cardPreview = $('cardPreview');
  const statusTagList = $('statusTagList');
  const statusTagsPreview = $('statusTagsPreview');

  const themeButtons = document.querySelectorAll('.theme-btn');
  const decorationBtns = document.querySelectorAll('.decoration-btn');

  // 既存があればそれを使う（元のHTMLに合わせる）
  const downloadBtn = $('downloadBtn');     // 旧「画像で保存」ボタン
  const copyTextBtn = $('copyTextBtn');     // テキストコピー


  // ---- constants ----
  const labels = {
    oneLiner: '一言',
    activeTime: '活動時間',
    favorite: '好きなワールド・アバター',
    friendRequest: 'フレンド申請',
    hobby: '趣味・興味',
  };

  const themeBgForExport = {
    modern: '#ffffff',
    industrial: '#1e1e1e',
    fantasy: '#3d2c2a',
    kawaii: '#fff8f5',
    chocolate: '#f0e0cc',
  };

  // ---- utils ----
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function wrapLine(label, value) {
    if (!value || !value.trim()) return '';
    return `<span class="label">${label}</span>${escapeHtml(value.trim())}`;
  }

  function getSelectedStatusTags() {
    if (!statusTagList) return [];
    const checkboxes = statusTagList.querySelectorAll('input[name="status"]:checked');
    return Array.from(checkboxes).map((cb) => cb.value);
  }

  function updateStatusTagsPreview() {
    if (!statusTagsPreview) return;
    const selected = getSelectedStatusTags();
    statusTagsPreview.innerHTML = '';
    selected.forEach((label) => {
      const chip = document.createElement('span');
      chip.className = 'status-chip';
      chip.textContent = label;
      statusTagsPreview.appendChild(chip);
    });
  }

  function updatePreview() {
    if (!cardPreview) return;

    const name = (fields.vrName?.value || '').trim() || 'VRChat名';
    if (preview.name) preview.name.textContent = name;

    const pro = (fields.pronouns?.value || '').trim();
    if (preview.pronouns) {
      preview.pronouns.textContent = pro;
      preview.pronouns.style.display = pro ? 'block' : 'none';
    }

    if (preview.oneLiner) preview.oneLiner.innerHTML = wrapLine(labels.oneLiner, fields.oneLiner?.value || '');
    if (preview.activeTime) preview.activeTime.innerHTML = wrapLine(labels.activeTime, fields.activeTime?.value || '');
    if (preview.favorite) preview.favorite.innerHTML = wrapLine(labels.favorite, fields.favorite?.value || '');
    if (preview.friendRequest) preview.friendRequest.innerHTML = wrapLine(labels.friendRequest, fields.friendRequest?.value || '');
    if (preview.hobby) preview.hobby.innerHTML = wrapLine(labels.hobby, fields.hobby?.value || '');

    updateStatusTagsPreview();
  }

  function getActiveThemeName() {
    if (!cardPreview) return 'modern';
    return cardPreview.classList.contains('industrial') ? 'industrial'
      : cardPreview.classList.contains('fantasy') ? 'fantasy'
      : cardPreview.classList.contains('kawaii') ? 'kawaii'
      : cardPreview.classList.contains('chocolate') ? 'chocolate'
      : 'modern';
  }

  // テーマ/装飾クラス組み立て（ボタンがある場合だけ）
  function getCardBaseClasses() {
    const themeBtn = document.querySelector('.theme-btn.active');
    const theme = themeBtn?.dataset?.theme || 'modern';

    const decoBtn = document.querySelector('.decoration-btn.active');
    const deco = decoBtn?.dataset?.decoration || 'none';
    const decoClass = deco === 'none' ? 'deco-none' : 'deco-' + deco;

    let c = 'card ' + theme + ' ' + decoClass;
    if (theme === 'chocolate') c += ' bg-check';
    return c;
  }

  function applyCardClasses() {
    if (!cardPreview) return;
    cardPreview.className = getCardBaseClasses();
  }

  // ---- avatar ----
  if (avatarInput && avatarPreview) {
    avatarInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file || !file.type.startsWith('image/')) {
        avatarPreview.style.display = 'none';
        avatarPreview.src = '';
        if (avatarPlaceholder) avatarPlaceholder.style.display = 'block';
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        avatarPreview.src = reader.result;
        avatarPreview.alt = 'アバター';
        avatarPreview.style.display = 'block';
        if (avatarPlaceholder) avatarPlaceholder.style.display = 'none';
      };
      reader.readAsDataURL(file);
    });
  }

  // ---- watermark ----
  if (watermarkInput && cardWatermark) {
    watermarkInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file || !file.type.startsWith('image/')) {
        cardWatermark.innerHTML = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        const opacity = watermarkOpacity ? Number(watermarkOpacity.value) : 30;
        cardWatermark.innerHTML = `<img src="${reader.result}" alt="">`;
        cardWatermark.style.opacity = String(opacity / 100);
      };
      reader.readAsDataURL(file);
    });
  }

  if (watermarkOpacity) {
    watermarkOpacity.addEventListener('input', () => {
      if (watermarkOpacityValue) watermarkOpacityValue.textContent = watermarkOpacity.value;
      if (cardWatermark) cardWatermark.style.opacity = String(Number(watermarkOpacity.value) / 100);
    });
  }

  // ---- theme ----
  if (themeButtons?.length) {
    themeButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        themeButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        applyCardClasses();
      });
    });
  }

  // ---- decoration (optional) ----
  if (decorationBtns?.length) {
    decorationBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        decorationBtns.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        applyCardClasses();
      });
    });
  }

  // ---- inputs bind ----
  Object.values(fields).forEach((el) => {
    if (!el) return;
    el.addEventListener('input', updatePreview);
    el.addEventListener('change', updatePreview);
  });

  if (statusTagList) statusTagList.addEventListener('change', updatePreview);

  // 初期反映
  updatePreview();
  applyCardClasses();

  // ---- text copy (optional) ----
  if (copyTextBtn) {
    copyTextBtn.addEventListener('click', () => {
      const statusTags = getSelectedStatusTags();
      const lines = [
        '【VRChat 自己紹介】',
        `名前: ${(fields.vrName?.value || '').trim()}`,
        (fields.pronouns?.value || '').trim() ? `Pronouns: ${fields.pronouns.value.trim()}` : '',
        statusTags.length ? `ステータス: ${statusTags.join(' / ')}` : '',
        (fields.oneLiner?.value || '').trim() ? `一言: ${fields.oneLiner.value.trim()}` : '',
        (fields.activeTime?.value || '').trim() ? `活動時間: ${fields.activeTime.value.trim()}` : '',
        (fields.favorite?.value || '').trim() ? `好きなワールド・アバター: ${fields.favorite.value.trim()}` : '',
        (fields.friendRequest?.value || '').trim() ? `フレンド申請: ${fields.friendRequest.value.trim()}` : '',
        (fields.hobby?.value || '').trim() ? `趣味: ${fields.hobby.value.trim()}` : '',
      ].filter(Boolean);

      const text = lines.join('\n');
      navigator.clipboard.writeText(text).then(
        () => alert('テキストをコピーしました'),
        () => alert('コピーに失敗しました')
      );
    });
  }

  // ---- screenshot popup (the “save” replacement) ----
  async function openScreenshotPopup() {
    try {
      if (document.fonts?.ready) await document.fonts.ready;

      const w = 980, h = 1400;
      const win = window.open('', '_blank', `popup=yes,width=${w},height=${h}`);
      if (!win) {
        alert('ポップアップがブロックされました。ブラウザ設定で許可してください。');
        return;
      }

      const EXPORT_W = 900;
      const EXPORT_H = 1200;

      // クローンを作る（画面側DOMは一切触らない）
      const clone = cardPreview.cloneNode(true);
      clone.removeAttribute('id');
      clone.querySelectorAll('[id]').forEach((el) => el.removeAttribute('id'));

      // スクショ用：3:4 をpx固定
      clone.style.width = EXPORT_W + 'px';
      clone.style.height = EXPORT_H + 'px';
      clone.style.maxWidth = 'none';
      clone.style.aspectRatio = 'auto';
      clone.style.margin = '0';
      clone.style.transform = 'none';
      clone.style.position = 'relative';

      const theme = getActiveThemeName();
      const bg = themeBgForExport[theme] || '#ffffff';

      // clone内の画像ロード待ち
      const imgs = Array.from(clone.querySelectorAll('img'));
      await Promise.all(imgs.map((img) => new Promise((resolve) => {
        if (img.complete && img.naturalWidth > 0) return resolve();
        img.addEventListener('load', resolve, { once: true });
        img.addEventListener('error', resolve, { once: true });
      })));

      // CSSをポップアップへコピー（cross-originは読めないので握りつぶす）
      const cssText = Array.from(document.styleSheets).map((ss) => {
        try { return Array.from(ss.cssRules).map((r) => r.cssText).join('\n'); }
        catch { return ''; }
      }).join('\n');

      // Font linkも複製（Google Fonts）
      const fontLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
        .map((l) => l.outerHTML)
        .join('\n');

      win.document.open();
      win.document.write(`<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>スクショ用カード</title>
${fontLinks}
<style>
${cssText}
html,body{margin:0;background:${bg};}
.stage{min-height:100vh;display:grid;place-items:center;padding:24px;}
.hint{position:fixed;top:12px;left:12px;font-size:12px;opacity:.75;
  background:rgba(255,255,255,.75);padding:8px 10px;border-radius:10px;user-select:none;}
@media (prefers-color-scheme: dark){
  .hint{background:rgba(0,0,0,.35);color:#fff;}
}
</style>
</head><body>
<div class="hint">このウィンドウをスクリーンショットしてください（3:4固定）</div>
<div class="stage" id="mount"></div>
</body></html>`);
      win.document.close();

      if (win.document.fonts?.ready) await win.document.fonts.ready;

      const mount = win.document.getElementById('mount');
      mount.appendChild(clone);

      // 1フレーム待ってレイアウトを落ち着かせる
      await new Promise((r) => win.requestAnimationFrame(() => r()));
    } catch (e) {
      alert('スクショ用ウィンドウを開けませんでした: ' + (e?.message || e));
    }
  }

  // どのボタンでも同じ動作にする
  if (screenshotBtn) screenshotBtn.addEventListener('click', openScreenshotPopup);
  if (downloadBtn) downloadBtn.addEventListener('click', openScreenshotPopup);
})();
</script>

</body>
</html>
